@model IEnumerable<Etalem.Models.DTOs.EnrollmentDto>

@{
    ViewData["Title"] = "Student Dashboard";
}

<h2 class="text-3xl font-bold mb-6 text-gray-900">Student Dashboard</h2>

<!-- Toast Container -->
<div aria-live="polite" aria-atomic="true" class="fixed top-4 right-4 z-50">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="bg-green-500 text-white p-4 rounded-md shadow-lg mb-2 toast" role="alert">
            <div class="flex justify-between items-center">
                <span class="font-semibold">Success</span>
                <button type="button" class="text-white hover:text-gray-200" onclick="this.parentElement.parentElement.style.display='none'">×</button>
            </div>
            <p class="mt-2">@TempData["SuccessMessage"]</p>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="bg-red-500 text-white p-4 rounded-md shadow-lg mb-2 toast" role="alert">
            <div class="flex justify-between items-center">
                <span class="font-semibold">Error</span>
                <button type="button" class="text-white hover:text-gray-200" onclick="this.parentElement.parentElement.style.display='none'">×</button>
            </div>
            <p class="mt-2">@TempData["ErrorMessage"]</p>
        </div>
    }
</div>

@if (!Model.Any())
{
    <div class="text-center text-gray-500 py-12 bg-gray-50 rounded-lg">
        <p class="text-lg">You haven't enrolled in any courses yet.</p>
        <a href="/Course" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Explore Courses</a>
    </div>
}
else
{
    <div class="space-y-6 m-6">
        @foreach (var enrollment in Model)
        {
            <div class="relative bg-white rounded-lg shadow-md flex flex-col sm:flex-row w-full">
                
                <div class="w-full sm:w-48 h-48 sm:h-auto flex-shrink-0">
                    @if (!string.IsNullOrEmpty(enrollment.ThumbnailUrl))
                    {
                        <img src="@enrollment.ThumbnailUrl" alt="@enrollment.CourseTitle" class="object-cover w-full h-full sm:h-48 rounded-l-lg sm:rounded-l-lg rounded-t-lg sm:rounded-t-none border border-gray-200" />
                    }
                    else
                    {
                        <div class="w-full sm:w-48 h-48 bg-gray-200 flex items-center justify-center rounded-l-lg sm:rounded-l-lg rounded-t-lg sm:rounded-t-none border border-gray-200">
                            <span class="text-gray-500 text-sm">No Thumbnail</span>
                        </div>
                    }
                </div>

               
                <div class="p-6 flex-1">
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="text-xl font-semibold text-gray-800">
                            <a href="@Url.Action("CourseContent", "Enrollment", new { courseId = enrollment.CourseId })" class="text-blue-600 hover:underline">@enrollment.CourseTitle</a>
                        </h2>
                        <div class="flex space-x-2">
                            <!-- زر تحميل الشهادة أو إنشائها -->
                            @if (!string.IsNullOrEmpty(enrollment.CertificateUrl))
                            {
                                <a href="@enrollment.CertificateUrl" target="_blank" class="flex items-center space-x-1 p-2 bg-green-600 text-white rounded-full hover:bg-green-700" title="Download Certificate">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    <span class="text-sm">Download Certificate</span>
                                </a>
                            }
                            else
                            {
                                <form asp-action="GenerateCertificate" asp-route-enrollmentId="@enrollment.Id" method="post" class="inline">
                                    <button type="submit" class="flex items-center space-x-1 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 @(enrollment.Progress == 100 ? "" : "opacity-50 cursor-not-allowed")" title="Generate Certificate" @(enrollment.Progress == 100 ? "" : "disabled")>
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m-9 3h18a2 2 0 002-2V6a2 2 0 00-2-2H3a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                        </svg>
                                        <span class="text-sm">Generate Certificate</span>
                                    </button>
                                </form>
                            }
                            <!-- زر حذف الـ Enrollment -->
                            @* <form asp-action="Delete" asp-route-id="@enrollment.Id" method="post" class="inline" onsubmit="return confirm('Are you sure you want to delete this enrollment?');"> *@
                            @*     <button type="submit" class="flex items-center space-x-1 p-2 bg-red-600 text-white rounded-full hover:bg-red-700" title="Delete"> *@
                            @*         <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> *@
                            @*             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path> *@
                            @*         </svg> *@
                            @*         <span class="text-sm">Delete</span> *@
                            @*     </button> *@
                            @* </form> *@
                        </div>
                    </div>

                   
                    <div class="flex items-center flex-wrap space-x-6 mb-4 text-gray-600">
                        <div>
                            <span class="font-medium">Enrolled:</span> @enrollment.EnrollmentDate.ToString("d MMM yyyy")
                        </div>
                        <div>
                            <span class="font-medium">Status:</span>
                            <span class="@(enrollment.IsCompleted ? "text-blue-600" : "text-orange-600") font-medium">@(enrollment.IsCompleted ? "Completed" : "In Progress")</span>
                            @if (enrollment.IsCompleted && enrollment.CompletedAt.HasValue)
                            {
                                <span class="block text-xs text-gray-500">Completed At: @enrollment.CompletedAt.Value.ToString("d MMM yyyy")</span>
                            }
                        </div>
                    </div>

                    <!-- شريط التقدم مع النسبة جنبه -->
                    <div class="mb-4 flex items-center space-x-3">
                        <span class="text-sm font-medium text-gray-600">Progress:</span>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: @enrollment.Progress%;"></div>
                        </div>
                        <span class="text-sm text-gray-600">@enrollment.Progress%</span>
                    </div>

                    <!-- أزرار العمليات -->
                    <div class="flex justify-between items-center">
                        <a href="@Url.Action("CourseContent", "Enrollment", new { courseId = enrollment.CourseId })" class="flex items-center space-x-1 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12H9m6 0a3 3 0 01-3 3m3-3a3 3 0 00-3-3m3 3h6m-9 0H3m9 9a9 9 0 100-18 9 9 0 000 18z"></path>
                            </svg>
                            <span class="text-sm">View Content</span>
                        </a>
                        <!-- زر Add Review -->
                        <button onclick="toggleReviewForm('review-form-@enrollment.Id')" class="flex items-center space-x-1 p-2 bg-indigo-600 text-white rounded-full hover:bg-indigo-700 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                            <span class="text-sm">Add Review</span>
                        </button>
                    </div>

                    <!-- مراجعة (مخفية في البداية) -->
                    <div id="review-form-@enrollment.Id" class="mt-4 p-3 bg-gray-50 rounded-md hidden">
                        <h4 class="text-sm font-semibold text-gray-900 mb-2">Leave a Review</h4>
                        <form asp-controller="Reviews" asp-action="Create" method="post" class="flex items-center space-x-2">
                            <input type="hidden" name="courseId" value="@enrollment.CourseId" />
                            <div class="flex-1">
                                <input type="number" name="rating" id="rating_@enrollment.Id" min="1" max="5" required placeholder="Rating (1-5)" class="border rounded p-1 w-full text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="flex-1">
                                <textarea name="comment" id="comment_@enrollment.Id" required placeholder="Your comment" class="border rounded p-1 w-full text-sm h-8 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <button type="submit" class="flex items-center space-x-1 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors duration-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <span class="text-sm">Submit</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
}

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // إخفاء الـ Toast بعد 5 ثواني
            setTimeout(() => {
                document.querySelectorAll('.toast').forEach(toast => {
                    toast.style.display = 'none';
                });
            }, 5000);
        });

        
        function toggleReviewForm(formId) {
            const form = document.getElementById(formId);
            form.classList.toggle('hidden');
        }
    </script>
}